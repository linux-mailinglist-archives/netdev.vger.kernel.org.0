Return-Path: <netdev-owner@vger.kernel.org>
X-Original-To: lists+netdev@lfdr.de
Delivered-To: lists+netdev@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 379F4583420
	for <lists+netdev@lfdr.de>; Wed, 27 Jul 2022 22:37:17 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S230392AbiG0UhM (ORCPT <rfc822;lists+netdev@lfdr.de>);
        Wed, 27 Jul 2022 16:37:12 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38880 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S229653AbiG0UhK (ORCPT
        <rfc822;netdev@vger.kernel.org>); Wed, 27 Jul 2022 16:37:10 -0400
Received: from mail-yb1-xb2b.google.com (mail-yb1-xb2b.google.com [IPv6:2607:f8b0:4864:20::b2b])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id A7F62140C3
        for <netdev@vger.kernel.org>; Wed, 27 Jul 2022 13:37:06 -0700 (PDT)
Received: by mail-yb1-xb2b.google.com with SMTP id r3so206083ybr.6
        for <netdev@vger.kernel.org>; Wed, 27 Jul 2022 13:37:06 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=googlemail.com; s=20210112;
        h=mime-version:from:date:message-id:subject:to:cc;
        bh=ARmpeeI8y85ixXpXRkbTb10UvWHcLuIMX1V5GvbqZfk=;
        b=bvqbVvt7d0e0MA8ES3EHcdD2cyE18/kQnEV+B0hWMLGdMu8C6iwGHtA0jyS222IkO9
         26cpMlwqjgqEu3gOzdsO93kQ+Qxx4rqKpIJ5PZstZh6mG1ELxRz1FrXagITz/11kP4zY
         F5FJpZ6EMabHUX5J9R+MRYYBvzdAKVTm4hkXiW2EGFhrOc/c99aV3G+rb6gIufZ/Vg/5
         e+LvnA6chbQmzYUR5rvjx7L8FnnAh5tnOuzNKLjFwdQvsGoX4UfAgOUBCYb6G2LN7HBL
         KTBTRsq55P443eX579jiBVSc6O2X+9PzsGBou4HI5EA3GTrQQY0qlPsQt/XrmPmnQMQc
         YE/A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=x-gm-message-state:mime-version:from:date:message-id:subject:to:cc;
        bh=ARmpeeI8y85ixXpXRkbTb10UvWHcLuIMX1V5GvbqZfk=;
        b=o8nQ+6X38AEj1lndVGCVf5BR5nJQEQNWBCg1iHAsmMNv7pWsX5SAvUka/enTsnJr+F
         xDiDN9Kef3lgFjGbdg55bFyQ0UxRHRQMCvXnA2Rix4jf35yI1UqiHPNdQkzgdCuuUEMo
         uUq/XxCfextRibOlIyy/ULXjemrLvsKqTYc0zgc4vPyefRYyhc148jYtdF0/4NAj7/Rw
         jtUPzuiU6BzVcETGmkn0u3Uxz80I+hXyT80LJzhRjg8wH+bE27kPvLr674txKy4HMaug
         YzDppo28+GPzblNKlaqBmtWQapn3G+winQnWeRiaK7fN5BEKgomqJ0gMRXdVaf9Y73Fv
         4t6g==
X-Gm-Message-State: AJIora/8JWik3+CJ9EsIZAXs1qRncy5JyxaWOAslVlPhatrG8S5lYNaR
        gVV3m7QouHAYHMIENys4yU0ReEY0zr8dkMYU+xHwzPtv40s=
X-Google-Smtp-Source: AGRyM1u4momlO/1UfbcBuK33RwqWL274J6h3JVdqqaWl3BgA+C44JIDylDuQkI/W+Xv1j78BuJcmwQwCZRCLBvC9CO0=
X-Received: by 2002:a25:9f05:0:b0:671:5aca:b0c4 with SMTP id
 n5-20020a259f05000000b006715acab0c4mr10479881ybq.29.1658954225721; Wed, 27
 Jul 2022 13:37:05 -0700 (PDT)
MIME-Version: 1.0
From:   Martin Blumenstingl <martin.blumenstingl@googlemail.com>
Date:   Wed, 27 Jul 2022 22:36:55 +0200
Message-ID: <CAFBinCDX5XRyMyOd-+c_Zkn6dawtBpQ9DaPkA4FDC5agL-t8CA@mail.gmail.com>
Subject: net: dsa: lantiq_gswip: getting the first selftests to pass
To:     netdev@vger.kernel.org
Cc:     andrew@lunn.ch, vivien.didelot@gmail.com, olteanv@gmail.com,
        Hauke Mehrtens <hauke@hauke-m.de>, f.fainelli@gmail.com,
        Aleksander Jan Bajkowski <olek2@wp.pl>
Content-Type: text/plain; charset="UTF-8"
X-Spam-Status: No, score=-2.1 required=5.0 tests=BAYES_00,DKIM_SIGNED,
        DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,FREEMAIL_FROM,
        RCVD_IN_DNSWL_NONE,SPF_HELO_NONE,SPF_PASS autolearn=ham
        autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <netdev.vger.kernel.org>
X-Mailing-List: netdev@vger.kernel.org

Hello,

there are some pending issues with the Lantiq GSWIP driver.
Vladimir suggested to get the kernel selftests to pass in a first step.
I am starting with
tools/testing/selftests/drivers/net/dsa/local_termination.sh as my
understanding is that this contains the most basic tests and should be
the first step.

The good news is that not all tests are broken!
There are eight tests which are not passing. Those eight can be split
into two groups of four, because it's the same four tests that are
failing for "standalone" and "bridge" interfaces:
- Unicast IPv4 to unknown MAC address
- Unicast IPv4 to unknown MAC address, allmulti
- Multicast IPv4 to unknown group
- Multicast IPv6 to unknown group

What they all have in common is the fact that we're expecting that no
packets are received. But in reality packets are received. I manually
confirmed this by examining the tcpdump file which is generated by the
selftests.

Vladimir suggested in [0]:
> [...] we'll need to make smaller steps, like disable address
> learning on standalone ports, isolate FDBs, maybe offload the bridge TX
> forwarding process (in order to populate the "Force no learning" bit in
> tag_gswip.c properly), and only then will the local_termination test
> also pass [...]

Based on the failing tests I am wondering which step would be a good
one to start with.
Is this problem that the selftests are seeing a flooding issue? In
that case I suspect that the "interesting behavior" (of the GSWIP's
flooding behavior) that Vladimir described in [1] would be a starting
point.

Full local_termination.sh selftest output:
TEST: lan2: Unicast IPv4 to primary MAC address                 [ OK ]
TEST: lan2: Unicast IPv4 to macvlan MAC address                 [ OK ]
TEST: lan2: Unicast IPv4 to unknown MAC address                 [FAIL]
        reception succeeded, but should have failed
TEST: lan2: Unicast IPv4 to unknown MAC address, promisc        [ OK ]
TEST: lan2: Unicast IPv4 to unknown MAC address, allmulti       [FAIL]
        reception succeeded, but should have failed
TEST: lan2: Multicast IPv4 to joined group                      [ OK ]
TEST: lan2: Multicast IPv4 to unknown group                     [FAIL]
        reception succeeded, but should have failed
TEST: lan2: Multicast IPv4 to unknown group, promisc            [ OK ]
TEST: lan2: Multicast IPv4 to unknown group, allmulti           [ OK ]
TEST: lan2: Multicast IPv6 to joined group                      [ OK ]
TEST: lan2: Multicast IPv6 to unknown group                     [FAIL]
        reception succeeded, but should have failed
TEST: lan2: Multicast IPv6 to unknown group, promisc            [ OK ]
TEST: lan2: Multicast IPv6 to unknown group, allmulti           [ OK ]
TEST: br0: Unicast IPv4 to primary MAC address                  [ OK ]
TEST: br0: Unicast IPv4 to macvlan MAC address                  [ OK ]
TEST: br0: Unicast IPv4 to unknown MAC address                  [FAIL]
        reception succeeded, but should have failed
TEST: br0: Unicast IPv4 to unknown MAC address, promisc         [ OK ]
TEST: br0: Unicast IPv4 to unknown MAC address, allmulti        [FAIL]
        reception succeeded, but should have failed
TEST: br0: Multicast IPv4 to joined group                       [ OK ]
TEST: br0: Multicast IPv4 to unknown group                      [FAIL]
        reception succeeded, but should have failed
TEST: br0: Multicast IPv4 to unknown group, promisc             [ OK ]
TEST: br0: Multicast IPv4 to unknown group, allmulti            [ OK ]
TEST: br0: Multicast IPv6 to joined group                       [ OK ]
TEST: br0: Multicast IPv6 to unknown group                      [FAIL]
        reception succeeded, but should have failed
TEST: br0: Multicast IPv6 to unknown group, promisc             [ OK ]
TEST: br0: Multicast IPv6 to unknown group, allmulti            [ OK ]


Thank you!
Best regards,
Martin

[0] https://lore.kernel.org/netdev/20220706210651.ozvjcwwp2hquzmhn@skbuf/
[1] https://lore.kernel.org/netdev/20220702185652.dpzrxuitacqp6m3t@skbuf/
