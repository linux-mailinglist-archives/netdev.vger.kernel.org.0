Return-Path: <netdev-owner@vger.kernel.org>
X-Original-To: lists+netdev@lfdr.de
Delivered-To: lists+netdev@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id DD0B2357C00
	for <lists+netdev@lfdr.de>; Thu,  8 Apr 2021 07:53:02 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S229748AbhDHFxL (ORCPT <rfc822;lists+netdev@lfdr.de>);
        Thu, 8 Apr 2021 01:53:11 -0400
Received: from mga12.intel.com ([192.55.52.136]:43808 "EHLO mga12.intel.com"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S229506AbhDHFxL (ORCPT <rfc822;netdev@vger.kernel.org>);
        Thu, 8 Apr 2021 01:53:11 -0400
IronPort-SDR: 6q1cotdL0wLj24hldFXGF/RY5mrmoWSXPAhmgkARHojg3xwO1R9GKg7yP6mxUrtQO/Bk8bAVbV
 i3TADhl54Zbw==
X-IronPort-AV: E=McAfee;i="6000,8403,9947"; a="172941055"
X-IronPort-AV: E=Sophos;i="5.82,205,1613462400"; 
   d="scan'208";a="172941055"
Received: from fmsmga008.fm.intel.com ([10.253.24.58])
  by fmsmga106.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 07 Apr 2021 22:53:00 -0700
IronPort-SDR: 3WenPqUuWm638v9dTGt129qyX2wo3uUG94iCCzCEQhH86Rt2gxBU3m2OU+khzyPPIps78yGkfO
 7MNvrWWZllDg==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.82,205,1613462400"; 
   d="scan'208";a="415601567"
Received: from irsmsx603.ger.corp.intel.com ([163.33.146.9])
  by fmsmga008.fm.intel.com with ESMTP; 07 Apr 2021 22:52:59 -0700
Received: from irsmsx604.ger.corp.intel.com (163.33.146.137) by
 irsmsx603.ger.corp.intel.com (163.33.146.9) with Microsoft SMTP Server
 (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256) id
 15.1.2106.2; Thu, 8 Apr 2021 06:52:59 +0100
Received: from irsmsx604.ger.corp.intel.com ([163.33.146.137]) by
 IRSMSX604.ger.corp.intel.com ([163.33.146.137]) with mapi id 15.01.2106.013;
 Thu, 8 Apr 2021 06:52:58 +0100
From:   "Loftus, Ciara" <ciara.loftus@intel.com>
To:     Andrii Nakryiko <andrii.nakryiko@gmail.com>
CC:     Networking <netdev@vger.kernel.org>, bpf <bpf@vger.kernel.org>,
        "Karlsson, Magnus" <magnus.karlsson@intel.com>,
        =?utf-8?B?QmrDtnJuIFTDtnBlbA==?= <bjorn@kernel.org>,
        Alexei Starovoitov <alexei.starovoitov@gmail.com>
Subject: RE: [PATCH v4 bpf 2/3] libbpf: restore umem state after socket create
 failure
Thread-Topic: [PATCH v4 bpf 2/3] libbpf: restore umem state after socket
 create failure
Thread-Index: AQHXJfk+x0bBYakYQESBw2lPJg1HlKqpU4GAgADXQIA=
Date:   Thu, 8 Apr 2021 05:52:58 +0000
Message-ID: <1449b25b2176449394ee07fea5750469@intel.com>
References: <20210331061218.1647-1-ciara.loftus@intel.com>
 <20210331061218.1647-3-ciara.loftus@intel.com>
 <CAEf4BzayWNm=kYqKz-6-P+fuRoy2UfPG8j8FuwXh5P6HDbsW9A@mail.gmail.com>
In-Reply-To: <CAEf4BzayWNm=kYqKz-6-P+fuRoy2UfPG8j8FuwXh5P6HDbsW9A@mail.gmail.com>
Accept-Language: en-GB, en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
dlp-product: dlpe-windows
dlp-reaction: no-action
dlp-version: 11.5.1.3
x-originating-ip: [163.33.253.164]
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
MIME-Version: 1.0
Precedence: bulk
List-ID: <netdev.vger.kernel.org>
X-Mailing-List: netdev@vger.kernel.org

PiBPbiBUdWUsIE1hciAzMCwgMjAyMSBhdCAxMTo0NSBQTSBDaWFyYSBMb2Z0dXMgPGNpYXJhLmxv
ZnR1c0BpbnRlbC5jb20+DQo+IHdyb3RlOg0KPiA+DQo+ID4gSWYgdGhlIGNhbGwgdG8geHNrX3Nv
Y2tldF9fY3JlYXRlIGZhaWxzLCB0aGUgdXNlciBtYXkgd2FudCB0byByZXRyeSB0aGUNCj4gPiBz
b2NrZXQgY3JlYXRpb24gdXNpbmcgdGhlIHNhbWUgdW1lbS4gRW5zdXJlIHRoYXQgdGhlIHVtZW0g
aXMgaW4gdGhlDQo+ID4gc2FtZSBzdGF0ZSBvbiBleGl0IGlmIHRoZSBjYWxsIGZhaWxzIGJ5Og0K
PiA+IDEuIGVuc3VyaW5nIHRoZSB1bWVtIF9zYXZlIHBvaW50ZXJzIGFyZSB1bm1vZGlmaWVkLg0K
PiA+IDIuIG5vdCB1bm1hcHBpbmcgdGhlIHNldCBvZiB1bWVtIHJpbmdzIHRoYXQgd2VyZSBzZXQg
dXAgd2l0aCB0aGUgdW1lbQ0KPiA+IGR1cmluZyB4c2tfdW1lbV9fY3JlYXRlLCBzaW5jZSB0aG9z
ZSBtYXBzIGV4aXN0ZWQgYmVmb3JlIHRoZSBjYWxsIHRvDQo+ID4geHNrX3NvY2tldF9fY3JlYXRl
IGFuZCBzaG91bGQgcmVtYWluIGluIHRhY3QgZXZlbiBpbiB0aGUgZXZlbnQgb2YNCj4gPiBmYWls
dXJlLg0KPiA+DQo+ID4gRml4ZXM6IDJmNjMyNGEzOTM3ZiAoImxpYmJwZjogU3VwcG9ydCBzaGFy
ZWQgdW1lbXMgYmV0d2VlbiBxdWV1ZXMgYW5kDQo+IGRldmljZXMiKQ0KPiA+DQo+ID4gU2lnbmVk
LW9mZi1ieTogQ2lhcmEgTG9mdHVzIDxjaWFyYS5sb2Z0dXNAaW50ZWwuY29tPg0KPiA+IC0tLQ0K
PiA+ICB0b29scy9saWIvYnBmL3hzay5jIHwgNDEgKysrKysrKysrKysrKysrKysrKysrKystLS0t
LS0tLS0tLS0tLS0tLS0NCj4gPiAgMSBmaWxlIGNoYW5nZWQsIDIzIGluc2VydGlvbnMoKyksIDE4
IGRlbGV0aW9ucygtKQ0KPiA+DQo+ID4gZGlmZiAtLWdpdCBhL3Rvb2xzL2xpYi9icGYveHNrLmMg
Yi90b29scy9saWIvYnBmL3hzay5jDQo+ID4gaW5kZXggNDQzYjBjZmI0NWU4Li41MDk4ZDllM2I1
NWEgMTAwNjQ0DQo+ID4gLS0tIGEvdG9vbHMvbGliL2JwZi94c2suYw0KPiA+ICsrKyBiL3Rvb2xz
L2xpYi9icGYveHNrLmMNCj4gPiBAQCAtNzQzLDI2ICs3NDMsMzAgQEAgc3RhdGljIHN0cnVjdCB4
c2tfY3R4ICp4c2tfZ2V0X2N0eChzdHJ1Y3QNCj4geHNrX3VtZW0gKnVtZW0sIGludCBpZmluZGV4
LA0KPiA+ICAgICAgICAgcmV0dXJuIE5VTEw7DQo+ID4gIH0NCj4gPg0KPiA+IC1zdGF0aWMgdm9p
ZCB4c2tfcHV0X2N0eChzdHJ1Y3QgeHNrX2N0eCAqY3R4KQ0KPiA+ICtzdGF0aWMgdm9pZCB4c2tf
cHV0X2N0eChzdHJ1Y3QgeHNrX2N0eCAqY3R4LCBib29sIHVubWFwKQ0KPiA+ICB7DQo+ID4gICAg
ICAgICBzdHJ1Y3QgeHNrX3VtZW0gKnVtZW0gPSBjdHgtPnVtZW07DQo+ID4gICAgICAgICBzdHJ1
Y3QgeGRwX21tYXBfb2Zmc2V0cyBvZmY7DQo+ID4gICAgICAgICBpbnQgZXJyOw0KPiA+DQo+ID4g
LSAgICAgICBpZiAoLS1jdHgtPnJlZmNvdW50ID09IDApIHsNCj4gPiAtICAgICAgICAgICAgICAg
ZXJyID0geHNrX2dldF9tbWFwX29mZnNldHModW1lbS0+ZmQsICZvZmYpOw0KPiA+IC0gICAgICAg
ICAgICAgICBpZiAoIWVycikgew0KPiA+IC0gICAgICAgICAgICAgICAgICAgICAgIG11bm1hcChj
dHgtPmZpbGwtPnJpbmcgLSBvZmYuZnIuZGVzYywNCj4gPiAtICAgICAgICAgICAgICAgICAgICAg
ICAgICAgICAgb2ZmLmZyLmRlc2MgKyB1bWVtLT5jb25maWcuZmlsbF9zaXplICoNCj4gPiAtICAg
ICAgICAgICAgICAgICAgICAgICAgICAgICAgc2l6ZW9mKF9fdTY0KSk7DQo+ID4gLSAgICAgICAg
ICAgICAgICAgICAgICAgbXVubWFwKGN0eC0+Y29tcC0+cmluZyAtIG9mZi5jci5kZXNjLA0KPiA+
IC0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZmYuY3IuZGVzYyArIHVtZW0tPmNvbmZp
Zy5jb21wX3NpemUgKg0KPiA+IC0gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaXplb2Yo
X191NjQpKTsNCj4gPiAtICAgICAgICAgICAgICAgfQ0KPiA+ICsgICAgICAgaWYgKC0tY3R4LT5y
ZWZjb3VudCkNCj4gPiArICAgICAgICAgICAgICAgcmV0dXJuOw0KPiA+DQo+ID4gLSAgICAgICAg
ICAgICAgIGxpc3RfZGVsKCZjdHgtPmxpc3QpOw0KPiA+IC0gICAgICAgICAgICAgICBmcmVlKGN0
eCk7DQo+ID4gLSAgICAgICB9DQo+ID4gKyAgICAgICBpZiAoIXVubWFwKQ0KPiA+ICsgICAgICAg
ICAgICAgICBnb3RvIG91dF9mcmVlOw0KPiA+ICsNCj4gPiArICAgICAgIGVyciA9IHhza19nZXRf
bW1hcF9vZmZzZXRzKHVtZW0tPmZkLCAmb2ZmKTsNCj4gPiArICAgICAgIGlmIChlcnIpDQo+ID4g
KyAgICAgICAgICAgICAgIGdvdG8gb3V0X2ZyZWU7DQo+ID4gKw0KPiA+ICsgICAgICAgbXVubWFw
KGN0eC0+ZmlsbC0+cmluZyAtIG9mZi5mci5kZXNjLCBvZmYuZnIuZGVzYyArIHVtZW0tDQo+ID5j
b25maWcuZmlsbF9zaXplICoNCj4gPiArICAgICAgICAgICAgICBzaXplb2YoX191NjQpKTsNCj4g
PiArICAgICAgIG11bm1hcChjdHgtPmNvbXAtPnJpbmcgLSBvZmYuY3IuZGVzYywgb2ZmLmNyLmRl
c2MgKyB1bWVtLQ0KPiA+Y29uZmlnLmNvbXBfc2l6ZSAqDQo+ID4gKyAgICAgICAgICAgICAgc2l6
ZW9mKF9fdTY0KSk7DQo+ID4gKw0KPiA+ICtvdXRfZnJlZToNCj4gPiArICAgICAgIGxpc3RfZGVs
KCZjdHgtPmxpc3QpOw0KPiA+ICsgICAgICAgZnJlZShjdHgpOw0KPiA+ICB9DQo+ID4NCj4gPiAg
c3RhdGljIHN0cnVjdCB4c2tfY3R4ICp4c2tfY3JlYXRlX2N0eChzdHJ1Y3QgeHNrX3NvY2tldCAq
eHNrLA0KPiA+IEBAIC03OTcsOCArODAxLDYgQEAgc3RhdGljIHN0cnVjdCB4c2tfY3R4ICp4c2tf
Y3JlYXRlX2N0eChzdHJ1Y3QNCj4geHNrX3NvY2tldCAqeHNrLA0KPiA+ICAgICAgICAgbWVtY3B5
KGN0eC0+aWZuYW1lLCBpZm5hbWUsIElGTkFNU0laIC0gMSk7DQo+ID4gICAgICAgICBjdHgtPmlm
bmFtZVtJRk5BTVNJWiAtIDFdID0gJ1wwJzsNCj4gPg0KPiA+IC0gICAgICAgdW1lbS0+ZmlsbF9z
YXZlID0gTlVMTDsNCj4gPiAtICAgICAgIHVtZW0tPmNvbXBfc2F2ZSA9IE5VTEw7DQo+ID4gICAg
ICAgICBjdHgtPmZpbGwgPSBmaWxsOw0KPiA+ICAgICAgICAgY3R4LT5jb21wID0gY29tcDsNCj4g
PiAgICAgICAgIGxpc3RfYWRkKCZjdHgtPmxpc3QsICZ1bWVtLT5jdHhfbGlzdCk7DQo+ID4gQEAg
LTg1NCw2ICs4NTYsNyBAQCBpbnQgeHNrX3NvY2tldF9fY3JlYXRlX3NoYXJlZChzdHJ1Y3QgeHNr
X3NvY2tldA0KPiAqKnhza19wdHIsDQo+ID4gICAgICAgICBzdHJ1Y3QgeHNrX3NvY2tldCAqeHNr
Ow0KPiA+ICAgICAgICAgc3RydWN0IHhza19jdHggKmN0eDsNCj4gPiAgICAgICAgIGludCBlcnIs
IGlmaW5kZXg7DQo+ID4gKyAgICAgICBib29sIHVubWFwID0gdW1lbS0+ZmlsbF9zYXZlICE9IGZp
bGw7DQo+ID4NCj4gDQo+IHdlIGFyZSBjaGVja2luZyAhdW1lbSBvbmx5IG9uIHRoZSBuZXh0IGxp
bmUsIHNvIGhlcmUgaXQgY2FuIGJlIHN0aWxsDQo+IE5VTEwuIFBsZWFzZSBzZW5kIGEgZml4LCB0
aGFua3MuDQoNClRoYW5rIHlvdSBmb3IgY2F0Y2hpbmcgdGhpcy4gSSd2ZSBzZW50IGEgZml4Lg0K
DQpDaWFyYQ0KDQo+IA0KPiA+ICAgICAgICAgaWYgKCF1bWVtIHx8ICF4c2tfcHRyIHx8ICEocngg
fHwgdHgpKQ0KPiA+ICAgICAgICAgICAgICAgICByZXR1cm4gLUVGQVVMVDsNCj4gPiBAQCAtOTk0
LDYgKzk5Nyw4IEBAIGludCB4c2tfc29ja2V0X19jcmVhdGVfc2hhcmVkKHN0cnVjdCB4c2tfc29j
a2V0DQo+ICoqeHNrX3B0ciwNCj4gPiAgICAgICAgIH0NCj4gPg0KPiA+ICAgICAgICAgKnhza19w
dHIgPSB4c2s7DQo+ID4gKyAgICAgICB1bWVtLT5maWxsX3NhdmUgPSBOVUxMOw0KPiA+ICsgICAg
ICAgdW1lbS0+Y29tcF9zYXZlID0gTlVMTDsNCj4gPiAgICAgICAgIHJldHVybiAwOw0KPiA+DQo+
ID4gIG91dF9tbWFwX3R4Og0KPiA+IEBAIC0xMDA1LDcgKzEwMTAsNyBAQCBpbnQgeHNrX3NvY2tl
dF9fY3JlYXRlX3NoYXJlZChzdHJ1Y3QgeHNrX3NvY2tldA0KPiAqKnhza19wdHIsDQo+ID4gICAg
ICAgICAgICAgICAgIG11bm1hcChyeF9tYXAsIG9mZi5yeC5kZXNjICsNCj4gPiAgICAgICAgICAg
ICAgICAgICAgICAgIHhzay0+Y29uZmlnLnJ4X3NpemUgKiBzaXplb2Yoc3RydWN0IHhkcF9kZXNj
KSk7DQo+ID4gIG91dF9wdXRfY3R4Og0KPiA+IC0gICAgICAgeHNrX3B1dF9jdHgoY3R4KTsNCj4g
PiArICAgICAgIHhza19wdXRfY3R4KGN0eCwgdW5tYXApOw0KPiA+ICBvdXRfc29ja2V0Og0KPiA+
ICAgICAgICAgaWYgKC0tdW1lbS0+cmVmY291bnQpDQo+ID4gICAgICAgICAgICAgICAgIGNsb3Nl
KHhzay0+ZmQpOw0KPiA+IEBAIC0xMDcxLDcgKzEwNzYsNyBAQCB2b2lkIHhza19zb2NrZXRfX2Rl
bGV0ZShzdHJ1Y3QgeHNrX3NvY2tldCAqeHNrKQ0KPiA+ICAgICAgICAgICAgICAgICB9DQo+ID4g
ICAgICAgICB9DQo+ID4NCj4gPiAtICAgICAgIHhza19wdXRfY3R4KGN0eCk7DQo+ID4gKyAgICAg
ICB4c2tfcHV0X2N0eChjdHgsIHRydWUpOw0KPiA+DQo+ID4gICAgICAgICB1bWVtLT5yZWZjb3Vu
dC0tOw0KPiA+ICAgICAgICAgLyogRG8gbm90IGNsb3NlIGFuIGZkIHRoYXQgYWxzbyBoYXMgYW4g
YXNzb2NpYXRlZCB1bWVtIGNvbm5lY3RlZA0KPiA+IC0tDQo+ID4gMi4xNy4xDQo+ID4NCg==
