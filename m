Return-Path: <netdev-owner@vger.kernel.org>
X-Original-To: lists+netdev@lfdr.de
Delivered-To: lists+netdev@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id BC86B35CA0C
	for <lists+netdev@lfdr.de>; Mon, 12 Apr 2021 17:37:28 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S242909AbhDLPho (ORCPT <rfc822;lists+netdev@lfdr.de>);
        Mon, 12 Apr 2021 11:37:44 -0400
Received: from mga05.intel.com ([192.55.52.43]:41987 "EHLO mga05.intel.com"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S238815AbhDLPho (ORCPT <rfc822;netdev@vger.kernel.org>);
        Mon, 12 Apr 2021 11:37:44 -0400
IronPort-SDR: +CLOIlWLHZ1jRutjBkm45L1l4tJSv7bwb4jWOum9xRdvYe8CSygLyXfwZ9l1rJqIMVHDqW1Ahk
 ux5yt2NLSmIw==
X-IronPort-AV: E=McAfee;i="6200,9189,9952"; a="279520284"
X-IronPort-AV: E=Sophos;i="5.82,216,1613462400"; 
   d="scan'208";a="279520284"
Received: from fmsmga005.fm.intel.com ([10.253.24.32])
  by fmsmga105.fm.intel.com with ESMTP/TLS/ECDHE-RSA-AES256-GCM-SHA384; 12 Apr 2021 08:37:13 -0700
IronPort-SDR: cuw1ILpAp+18grYJ1Py8CvzrFuIfh3PdUuswheY9KGzzGGlkVDLoDpn/2iyE//8a6gJJY2sSKI
 G+rqQGam+/4Q==
X-ExtLoop1: 1
X-IronPort-AV: E=Sophos;i="5.82,216,1613462400"; 
   d="scan'208";a="614609528"
Received: from glass.png.intel.com ([10.158.65.59])
  by fmsmga005.fm.intel.com with ESMTP; 12 Apr 2021 08:37:06 -0700
From:   Ong Boon Leong <boon.leong.ong@intel.com>
To:     Giuseppe Cavallaro <peppe.cavallaro@st.com>,
        Alexandre Torgue <alexandre.torgue@st.com>,
        Jose Abreu <joabreu@synopsys.com>,
        "David S . Miller" <davem@davemloft.net>,
        Jakub Kicinski <kuba@kernel.org>,
        Alexei Starovoitov <ast@kernel.org>,
        Daniel Borkmann <daniel@iogearbox.net>,
        Jesper Dangaard Brouer <hawk@kernel.org>,
        John Fastabend <john.fastabend@gmail.com>
Cc:     Maxime Coquelin <mcoquelin.stm32@gmail.com>,
        Andrii Nakryiko <andrii@kernel.org>,
        Martin KaFai Lau <kafai@fb.com>,
        Song Liu <songliubraving@fb.com>, Yonghong Song <yhs@fb.com>,
        KP Singh <kpsingh@kernel.org>, netdev@vger.kernel.org,
        linux-stm32@st-md-mailman.stormreply.com,
        linux-arm-kernel@lists.infradead.org, linux-kernel@vger.kernel.org,
        bpf@vger.kernel.org, Ong Boon Leong <boon.leong.ong@intel.com>
Subject: [PATCH net-next 0/7] stmmac: add XDP ZC support
Date:   Mon, 12 Apr 2021 23:41:23 +0800
Message-Id: <20210412154130.20742-1-boon.leong.ong@intel.com>
X-Mailer: git-send-email 2.25.1
MIME-Version: 1.0
Content-Transfer-Encoding: 8bit
Precedence: bulk
List-ID: <netdev.vger.kernel.org>
X-Mailing-List: netdev@vger.kernel.org

Hi,

This is the v1 patch series to add XDP ZC support to stmmac driver and
the changes are as listed in below summary:-

1-4/7: Refactor RX & TX buffer allocation and initialization to prepare
       stmmac driver for XSK RX & TX pool enabling and disabling.

5/7: Refactor stmmac_xdp_run_prog() for XDP ZC use which does not need
     to check for XDP program loaded.

6-7/7: XDP ZC RX and TX enabling.

The above patch series have been tested using xdpsock app in samples/bpf
directory on Intel mGbE controller. The DUT receives burst traffic
packets generated by using pktgen_sample03_burst_single_flow.sh in
samples/pktgen.

########################################################################

==========
A) RX-Only
==========

root@intel-corei7-64:~ $ ./xdpsock  -i eth0 -r -S

 sock0@eth0:0 rxdrop xdp-skb
                   pps            pkts           1.00
rx                 112161         12229475
tx                 0              0

 sock0@eth0:0 rxdrop xdp-skb
                   pps            pkts           1.00
rx                 112280         12341779
tx                 0              0

 sock0@eth0:0 rxdrop xdp-skb
                   pps            pkts           1.00
rx                 112358         12454155
tx                 0              0

 ====================================================

root@intel-corei7-64:~ $ ./xdpsock  -i eth0 -r -N -c

 sock0@eth0:0 rxdrop xdp-drv
                   pps            pkts           1.00
rx                 681082         2616133
tx                 0              0

 sock0@eth0:0 rxdrop xdp-drv
                   pps            pkts           1.00
rx                 681205         3297415
tx                 0              0

 sock0@eth0:0 rxdrop xdp-drv
                   pps            pkts           1.00
rx                 681386         3978873
tx                 0              0

 ====================================================

root@intel-corei7-64:~ $ ./xdpsock  -i eth0 -r -z

 sock0@eth0:0 rxdrop xdp-drv
                   pps            pkts           1.00
rx                 703915         19579779
tx                 0              0

 sock0@eth0:0 rxdrop xdp-drv
                   pps            pkts           1.00
rx                 703766         20283768
tx                 0              0

 sock0@eth0:0 rxdrop xdp-drv
                   pps            pkts           1.00
rx                 703383         20987229
tx                 0              0

==========
B) TX-Only
==========

root@intel-corei7-64:~ $ ./xdpsock -i eth0 -t -S

 sock0@eth0:0 txonly xdp-skb
                   pps            pkts           1.00
rx                 0              0
tx                 140269         4326720

 sock0@eth0:0 txonly xdp-skb
                   pps            pkts           1.00
rx                 0              0
tx                 140514         4467264

 sock0@eth0:0 txonly xdp-skb
                   pps            pkts           1.00
rx                 0              0
tx                 140009         4607296

 ====================================================

root@intel-corei7-64:~ $ ./xdpsock -i eth0 -t -N -c

 sock0@eth0:0 txonly xdp-drv
                   pps            pkts           1.00
rx                 0              0
tx                 138222         3108160

 sock0@eth0:0 txonly xdp-drv
                   pps            pkts           1.00
rx                 0              0
tx                 139629         3247872

 sock0@eth0:0 txonly xdp-drv
                   pps            pkts           1.00
rx                 0              0
tx                 139821         3387712

 ====================================================

root@intel-corei7-64:~ $ ./xdpsock -i eth0 -t -z

 sock0@eth0:0 txonly xdp-drv
                   pps            pkts           1.00
rx                 0              0
tx                 447382         13390848

 sock0@eth0:0 txonly xdp-drv
                   pps            pkts           1.00
rx                 0              0
tx                 447384         13838272

 sock0@eth0:0 txonly xdp-drv
                   pps            pkts           1.00
rx                 0              0
tx                 447384         14285696

================
C) L2 Forwarding
================

root@intel-corei7-64:~ $ ./xdpsock -i eth0 -l -S

 sock0@eth0:0 l2fwd xdp-skb
                   pps            pkts           1.00
rx                 85021          7363434
tx                 85021          7363434

 sock0@eth0:0 l2fwd xdp-skb
                   pps            pkts           1.00
rx                 85003          7448446
tx                 85003          7448446

 sock0@eth0:0 l2fwd xdp-skb
                   pps            pkts           1.00
rx                 84946          7533403
tx                 84946          7533403

 ====================================================

root@intel-corei7-64:~ $ ./xdpsock -i eth0 -l -N -c

 sock0@eth0:0 l2fwd xdp-drv
                   pps            pkts           1.00
rx                 132136         1092673
tx                 132072         1092609

 sock0@eth0:0 l2fwd xdp-drv
                   pps            pkts           1.00
rx                 132428         1225118
tx                 132428         1225054

 sock0@eth0:0 l2fwd xdp-drv
                   pps            pkts           1.00
rx                 132623         1357757
tx                 132623         1357693

 ====================================================

root@intel-corei7-64:~ $ ./xdpsock -i eth0 -l -z

 sock0@eth0:0 l2fwd xdp-drv
                   pps            pkts           1.00
rx                 468476         43619530
tx                 468476         43619466

 sock0@eth0:0 l2fwd xdp-drv
                   pps            pkts           1.00
rx                 468633         44088218
tx                 468633         44088154

 sock0@eth0:0 l2fwd xdp-drv
                   pps            pkts           1.00
rx                 468439         44556775
tx                 468439         44556711

 ########################################################################

Based on the results obtained from above using xdpsock test cases, the
result looks promising. It will be great if community can help to review
and test the above patch series on your respective platform and provide
me feedback for any improvement.

Thank you very much,
Boon Leong

Ong Boon Leong (7):
  net: stmmac: rearrange RX buffer allocation and free functions
  net: stmmac: introduce dma_recycle_rx_skbufs for
    stmmac_reinit_rx_buffers
  net: stmmac: refactor stmmac_init_rx_buffers for
    stmmac_reinit_rx_buffers
  net: stmmac: rearrange RX and TX desc init into per-queue basis
  net: stmmac: Refactor __stmmac_xdp_run_prog for XDP ZC
  net: stmmac: Enable RX via AF_XDP zero-copy
  net: stmmac: Add TX via XDP zero-copy socket

 drivers/net/ethernet/stmicro/stmmac/stmmac.h  |   24 +-
 .../net/ethernet/stmicro/stmmac/stmmac_main.c | 1698 +++++++++++++----
 .../net/ethernet/stmicro/stmmac/stmmac_xdp.c  |   94 +
 .../net/ethernet/stmicro/stmmac/stmmac_xdp.h  |    3 +
 4 files changed, 1396 insertions(+), 423 deletions(-)

-- 
2.25.1

