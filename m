Return-Path: <netdev-owner@vger.kernel.org>
X-Original-To: lists+netdev@lfdr.de
Delivered-To: lists+netdev@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 22BD2301865
	for <lists+netdev@lfdr.de>; Sat, 23 Jan 2021 21:46:56 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726344AbhAWUpO (ORCPT <rfc822;lists+netdev@lfdr.de>);
        Sat, 23 Jan 2021 15:45:14 -0500
Received: from mail.kernel.org ([198.145.29.99]:50748 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1726021AbhAWUpH (ORCPT <rfc822;netdev@vger.kernel.org>);
        Sat, 23 Jan 2021 15:45:07 -0500
Received: by mail.kernel.org (Postfix) with ESMTPSA id 15DA122C7C;
        Sat, 23 Jan 2021 20:44:26 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1611434666;
        bh=dDifY64EOySZnXzXe+Uf7zQzbNgpmjxFI49d+ObctgI=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=gShfGt+U+a9FeGd/oE6eBGAI5PPCqYf4KRq1/0wwBTn3JXaURVnNhVn6gAdpMXKt9
         E/gBMlRqZbwbQvw2/AQceOLAar/w/hGqheTBmroOnMYmE+cnjdRThC4/87ZA72u/l1
         aiVW+rtdqmhVAVeNliDak7cjsBFlkbIcgjwH4MRpCFY9wLpX9klGIEODrHES8WFOLn
         DsCoU6lV9e7G/JuuZcmw00oRve63i4gKqr836YoT6jH32adFRiDRXmVvBkl52VRzOI
         9BZypg1Fa4ACnEuIOK3rJ/fa/sBS4n6yzP9EtuSBBuPnfZV6QNEHcZgN8UYv4CqWWa
         jdmGuejEfM++g==
Date:   Sat, 23 Jan 2021 12:44:25 -0800
From:   Jakub Kicinski <kuba@kernel.org>
To:     Rasmus Villemoes <rasmus.villemoes@prevas.dk>
Cc:     Horatiu Vultur <horatiu.vultur@microchip.com>,
        netdev@vger.kernel.org, Jiri Pirko <jiri@mellanox.com>,
        Florian Fainelli <f.fainelli@gmail.com>,
        Petr Machata <petrm@mellanox.com>,
        Ido Schimmel <idosch@mellanox.com>,
        "David S . Miller" <davem@davemloft.net>,
        Ivan Vecera <ivecera@redhat.com>
Subject: Re: [PATCH resend net] net: switchdev: don't set
 port_obj_info->handled true when -EOPNOTSUPP
Message-ID: <20210123124425.324b8a94@kicinski-fedora-pc1c0hjn.dhcp.thefacebook.com>
In-Reply-To: <6f2ccc42-f6e3-201d-2bbd-05a78860fa63@prevas.dk>
References: <20210121234317.65936-1-rasmus.villemoes@prevas.dk>
        <20210122090505.3tb4idcvrjd4zcwe@soft-dev3.localdomain>
        <6f2ccc42-f6e3-201d-2bbd-05a78860fa63@prevas.dk>
MIME-Version: 1.0
Content-Type: text/plain; charset=US-ASCII
Content-Transfer-Encoding: 7bit
Precedence: bulk
List-ID: <netdev.vger.kernel.org>
X-Mailing-List: netdev@vger.kernel.org

On Fri, 22 Jan 2021 14:36:08 +0100 Rasmus Villemoes wrote:
> On 22/01/2021 10.05, Horatiu Vultur wrote:
> > The 01/22/2021 00:43, Rasmus Villemoes wrote:  
> >>
> >> It's not true that switchdev_port_obj_notify() only inspects the  
> >> ->handled field of "struct switchdev_notifier_port_obj_info" if  
> >> call_switchdev_blocking_notifiers() returns 0 - there's a WARN_ON()
> >> triggering for a non-zero return combined with ->handled not being
> >> true. But the real problem here is that -EOPNOTSUPP is not being
> >> properly handled.
> >>
> >> The wrapper functions switchdev_handle_port_obj_add() et al change a
> >> return value of -EOPNOTSUPP to 0, and the treatment of ->handled in
> >> switchdev_port_obj_notify() seems to be designed to change that back
> >> to -EOPNOTSUPP in case nobody actually acted on the notifier (i.e.,
> >> everybody returned -EOPNOTSUPP).
> >>
> >> Currently, as soon as some device down the stack passes the check_cb()
> >> check, ->handled gets set to true, which means that
> >> switchdev_port_obj_notify() cannot actually ever return -EOPNOTSUPP.
> >>
> >> This, for example, means that the detection of hardware offload
> >> support in the MRP code is broken - br_mrp_set_ring_role() always ends
> >> up setting mrp->ring_role_offloaded to 1, despite not a single
> >> mainline driver implementing any of the SWITCHDEV_OBJ_ID*_MRP. So
> >> since the MRP code thinks the generation of MRP test frames has been
> >> offloaded, no such frames are actually put on the wire.  
> > 
> > Just a small correction to what you have said regarding MRP. Is not the
> > option mrp->ring_role_offload that determines if the MRP Test frames are
> > generated by the HW but is the return value of the function
> > 'br_mrp_switchdev_send_ring_test' called from function
> > 'br_mrp_start_test'.  
> 
> Hm, you're right, but the underlying problem is the same:
> br_mrp_switchdev_set_ring_role() (whose return value is what is used to
> determine ->ing_role_offloaded) and br_mrp_switchdev_send_ring_test()
> both make use of switchdev_port_obj_add(SWITCHDEV_OBJ_ID_*MRP), and that
> function is currently unable to return -EOPNOTSUPP, which it must in
> order for the MRP logic to work.

Could you reword the commit message to avoid confusion for folks
reading git history and repost? You can keep Petr's tag.
