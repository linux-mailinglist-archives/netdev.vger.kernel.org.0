Return-Path: <netdev-owner@vger.kernel.org>
X-Original-To: lists+netdev@lfdr.de
Delivered-To: lists+netdev@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id C78D22D8535
	for <lists+netdev@lfdr.de>; Sat, 12 Dec 2020 07:46:12 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2438466AbgLLGpP (ORCPT <rfc822;lists+netdev@lfdr.de>);
        Sat, 12 Dec 2020 01:45:15 -0500
Received: from szxga01-in.huawei.com ([45.249.212.187]:4114 "EHLO
        szxga01-in.huawei.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2438405AbgLLGoj (ORCPT
        <rfc822;netdev@vger.kernel.org>); Sat, 12 Dec 2020 01:44:39 -0500
Received: from DGGEMM401-HUB.china.huawei.com (unknown [172.30.72.55])
        by szxga01-in.huawei.com (SkyGuard) with ESMTP id 4CtJ4y3bDczXm7s;
        Sat, 12 Dec 2020 14:43:14 +0800 (CST)
Received: from DGGEMM513-MBX.china.huawei.com ([169.254.1.120]) by
 DGGEMM401-HUB.china.huawei.com ([10.3.20.209]) with mapi id 14.03.0487.000;
 Sat, 12 Dec 2020 14:43:35 +0800
From:   wangyunjian <wangyunjian@huawei.com>
To:     Willem de Bruijn <willemdebruijn.kernel@gmail.com>
CC:     "Michael S. Tsirkin" <mst@redhat.com>,
        Jason Wang <jasowang@redhat.com>,
        "virtualization@lists.linux-foundation.org" 
        <virtualization@lists.linux-foundation.org>,
        Network Development <netdev@vger.kernel.org>,
        "Lilijun (Jerry)" <jerry.lilijun@huawei.com>,
        chenchanghu <chenchanghu@huawei.com>,
        xudingke <xudingke@huawei.com>,
        "huangbin (J)" <brian.huangbin@huawei.com>
Subject: RE: [PATCH net v2] tun: fix ubuf refcount incorrectly on error path
Thread-Topic: [PATCH net v2] tun: fix ubuf refcount incorrectly on error path
Thread-Index: AQHWziird30mYoLkpUK6A8EHcMEb7qnuUNCAgASAshA=
Date:   Sat, 12 Dec 2020 06:43:34 +0000
Message-ID: <34EFBCA9F01B0748BEB6B629CE643AE60DB6E3B3@dggemm513-mbx.china.huawei.com>
References: <1606982459-41752-1-git-send-email-wangyunjian@huawei.com>
 <1607517703-18472-1-git-send-email-wangyunjian@huawei.com>
 <CA+FuTSfQoDr0jd76xBXSvchhyihQaL2UQXeCR6frJ7hyXxbmVA@mail.gmail.com>
In-Reply-To: <CA+FuTSfQoDr0jd76xBXSvchhyihQaL2UQXeCR6frJ7hyXxbmVA@mail.gmail.com>
Accept-Language: en-US
Content-Language: zh-CN
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [10.174.243.127]
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: base64
MIME-Version: 1.0
X-CFilter-Loop: Reflected
Precedence: bulk
List-ID: <netdev.vger.kernel.org>
X-Mailing-List: netdev@vger.kernel.org

PiAtLS0tLU9yaWdpbmFsIE1lc3NhZ2UtLS0tLQ0KPiBGcm9tOiBXaWxsZW0gZGUgQnJ1aWpuIFtt
YWlsdG86d2lsbGVtZGVicnVpam4ua2VybmVsQGdtYWlsLmNvbV0NCj4gU2VudDogV2VkbmVzZGF5
LCBEZWNlbWJlciA5LCAyMDIwIDEwOjQzIFBNDQo+IFRvOiB3YW5neXVuamlhbiA8d2FuZ3l1bmpp
YW5AaHVhd2VpLmNvbT4NCj4gQ2M6IE1pY2hhZWwgUy4gVHNpcmtpbiA8bXN0QHJlZGhhdC5jb20+
OyBKYXNvbiBXYW5nDQo+IDxqYXNvd2FuZ0ByZWRoYXQuY29tPjsgdmlydHVhbGl6YXRpb25AbGlz
dHMubGludXgtZm91bmRhdGlvbi5vcmc7IE5ldHdvcmsNCj4gRGV2ZWxvcG1lbnQgPG5ldGRldkB2
Z2VyLmtlcm5lbC5vcmc+OyBMaWxpanVuIChKZXJyeSkNCj4gPGplcnJ5LmxpbGlqdW5AaHVhd2Vp
LmNvbT47IGNoZW5jaGFuZ2h1IDxjaGVuY2hhbmdodUBodWF3ZWkuY29tPjsNCj4geHVkaW5na2Ug
PHh1ZGluZ2tlQGh1YXdlaS5jb20+DQo+IFN1YmplY3Q6IFJlOiBbUEFUQ0ggbmV0IHYyXSB0dW46
IGZpeCB1YnVmIHJlZmNvdW50IGluY29ycmVjdGx5IG9uIGVycm9yIHBhdGgNCj4gDQo+IE9uIFdl
ZCwgRGVjIDksIDIwMjAgYXQgODowMyBBTSB3YW5neXVuamlhbiA8d2FuZ3l1bmppYW5AaHVhd2Vp
LmNvbT4NCj4gd3JvdGU6DQo+ID4NCj4gPiBGcm9tOiBZdW5qaWFuIFdhbmcgPHdhbmd5dW5qaWFu
QGh1YXdlaS5jb20+DQo+ID4NCj4gPiBBZnRlciBzZXR0aW5nIGNhbGxiYWNrIGZvciB1YnVmX2lu
Zm8gb2Ygc2tiLCB0aGUgY2FsbGJhY2sNCj4gPiAodmhvc3RfbmV0X3plcm9jb3B5X2NhbGxiYWNr
KSB3aWxsIGJlIGNhbGxlZCB0byBkZWNyZWFzZSB0aGUgcmVmY291bnQNCj4gPiB3aGVuIGZyZWVp
bmcgc2tiLiBCdXQgd2hlbiBhbiBleGNlcHRpb24gb2NjdXJzDQo+IA0KPiBXaXRoIGV4Y2VwdGlv
biwgeW91IG1lYW4gaWYgdHVuX2dldF91c2VyIHJldHVybnMgYW4gZXJyb3IgdGhhdCBwcm9wYWdh
dGVzIHRvDQo+IHRoZSBzZW5kbXNnIGNhbGwgaW4gdmhvc3QgaGFuZGxlX3R4LCBjb3JyZWN0Pw0K
DQpZZXMNCg0KPiANCj4gPiBhZnRlcndhcmRzLCB0aGUgZXJyb3IgaGFuZGxpbmcgaW4gdmhvc3Qg
aGFuZGxlX3R4KCkgd2lsbCB0cnkgdG8NCj4gPiBkZWNyZWFzZSB0aGUgc2FtZSByZWZjb3VudCBh
Z2Fpbi4gVGhpcyBpcyB3cm9uZyBhbmQgZml4IHRoaXMgYnkgZGVsYXkNCj4gPiBjb3B5aW5nIHVi
dWZfaW5mbyB1bnRpbCB3ZSdyZSBzdXJlIHRoZXJlJ3Mgbm8gZXJyb3JzLg0KPiANCj4gSSB0aGlu
ayB0aGUgcmlnaHQgYXBwcm9hY2ggaXMgdG8gYWRkcmVzcyB0aGlzIGluIHRoZSBlcnJvciBwYXRo
cywgcmF0aGVyIHRoYW4NCj4gY29tcGxpY2F0ZSB0aGUgbm9ybWFsIGRhdGFwYXRoLg0KPiANCj4g
SXMgaXQgc3VmZmljaWVudCB0byBzdXBwcmVzcyB0aGUgY2FsbCB0byB2aG9zdF9uZXRfdWJ1Zl9w
dXQgaW4gdGhlIGhhbmRsZV90eA0KPiBzZW5kbXNnIGVycm9yIHBhdGgsIGdpdmVuIHRoYXQgdmhv
c3RfemVyb2NvcHlfY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgb24NCj4ga2ZyZWVfc2tiPw0KDQpX
ZSBjYW4gbm90IGNhbGwga2ZyZWVfc2tiKCkgdW50aWwgdGhlIHNrYiB3YXMgY3JlYXRlZC4NCg0K
PiANCj4gT3IgYWx0ZXJuYXRpdmVseSBjbGVhciB0aGUgZGVzdHJ1Y3RvciBpbiBkcm9wOg0KDQpU
aGUgdWFyZy0+Y2FsbGJhY2soKSBpcyBjYWxsZWQgaW1tZWRpYXRlbHkgYWZ0ZXIgd2UgZGVjaWRl
IGRvIGRhdGFjb3B5DQpldmVuIGlmIGNhbGxlciB3YW50IHRvIGRvIHplcm9jb3B5LiBJZiBhbm90
aGVyIGVycm9yIG9jY3VycyBsYXRlciwgdGhlIHZob3N0DQpoYW5kbGVfdHgoKSB3aWxsIHRyeSB0
byBkZWNyZWFzZSBpdCBhZ2Fpbi4NCg0KVGhhbmtzDQo+IA0KPiA+DQo+ID4gRml4ZXM6IDQ0Nzcx
MzhmYTBhZSAoInR1bjogcHJvcGVybHkgdGVzdCBmb3IgSUZGX1VQIikNCj4gPiBGaXhlczogOTBl
MzNkNDU5NDA3ICgidHVuOiBlbmFibGUgbmFwaV9ncm9fZnJhZ3MoKSBmb3IgVFVOL1RBUA0KPiA+
IGRyaXZlciIpDQo+ID4NCj4gPiBTaWduZWQtb2ZmLWJ5OiBZdW5qaWFuIFdhbmcgPHdhbmd5dW5q
aWFuQGh1YXdlaS5jb20+DQo+ID4gLS0tDQo+ID4gdjI6DQo+ID4gICAgVXBkYXRlZCBjb2RlLCBm
aXggYnkgZGVsYXkgY29weWluZyB1YnVmX2luZm8NCj4gPiAtLS0NCj4gPiAgZHJpdmVycy9uZXQv
dHVuLmMgfCAyOSArKysrKysrKysrKysrKysrKysrLS0tLS0tLS0tLQ0KPiA+ICAxIGZpbGUgY2hh
bmdlZCwgMTkgaW5zZXJ0aW9ucygrKSwgMTAgZGVsZXRpb25zKC0pDQo+ID4NCj4gPiBkaWZmIC0t
Z2l0IGEvZHJpdmVycy9uZXQvdHVuLmMgYi9kcml2ZXJzL25ldC90dW4uYyBpbmRleA0KPiA+IDJk
YzE5ODhhODk3My4uMmVhODIyMzI4ZTczIDEwMDY0NA0KPiA+IC0tLSBhL2RyaXZlcnMvbmV0L3R1
bi5jDQo+ID4gKysrIGIvZHJpdmVycy9uZXQvdHVuLmMNCj4gPiBAQCAtMTYzNyw2ICsxNjM3LDIw
IEBAIHN0YXRpYyBzdHJ1Y3Qgc2tfYnVmZiAqdHVuX2J1aWxkX3NrYihzdHJ1Y3QNCj4gdHVuX3N0
cnVjdCAqdHVuLA0KPiA+ICAgICAgICAgcmV0dXJuIE5VTEw7DQo+ID4gIH0NCj4gPg0KPiA+ICsv
KiBjb3B5IHVidWZfaW5mbyBmb3IgY2FsbGJhY2sgd2hlbiBza2IgaGFzIG5vIGVycm9yICovIHN0
YXRpYyBpbmxpbmUNCj4gPiArdm9pZCB0dW5fY29weV91YnVmX2luZm8oc3RydWN0IHNrX2J1ZmYg
KnNrYiwgYm9vbCB6ZXJvY29weSwgdm9pZA0KPiA+ICsqbXNnX2NvbnRyb2wpIHsNCj4gPiArICAg
ICAgIGlmICh6ZXJvY29weSkgew0KPiA+ICsgICAgICAgICAgICAgICBza2Jfc2hpbmZvKHNrYikt
PmRlc3RydWN0b3JfYXJnID0gbXNnX2NvbnRyb2w7DQo+ID4gKyAgICAgICAgICAgICAgIHNrYl9z
aGluZm8oc2tiKS0+dHhfZmxhZ3MgfD0gU0tCVFhfREVWX1pFUk9DT1BZOw0KPiA+ICsgICAgICAg
ICAgICAgICBza2Jfc2hpbmZvKHNrYiktPnR4X2ZsYWdzIHw9IFNLQlRYX1NIQVJFRF9GUkFHOw0K
PiA+ICsgICAgICAgfSBlbHNlIGlmIChtc2dfY29udHJvbCkgew0KPiA+ICsgICAgICAgICAgICAg
ICBzdHJ1Y3QgdWJ1Zl9pbmZvICp1YXJnID0gbXNnX2NvbnRyb2w7DQo+ID4gKw0KPiA+ICsgICAg
ICAgICAgICAgICB1YXJnLT5jYWxsYmFjayh1YXJnLCBmYWxzZSk7DQo+ID4gKyAgICAgICB9DQo+
ID4gK30NCj4gPiArDQo+ID4gIC8qIEdldCBwYWNrZXQgZnJvbSB1c2VyIHNwYWNlIGJ1ZmZlciAq
LyAgc3RhdGljIHNzaXplX3QNCj4gPiB0dW5fZ2V0X3VzZXIoc3RydWN0IHR1bl9zdHJ1Y3QgKnR1
biwgc3RydWN0IHR1bl9maWxlICp0ZmlsZSwNCj4gPiAgICAgICAgICAgICAgICAgICAgICAgICAg
ICAgdm9pZCAqbXNnX2NvbnRyb2wsIHN0cnVjdCBpb3ZfaXRlciAqZnJvbSwNCj4gPiBAQCAtMTgx
MiwxNiArMTgyNiw2IEBAIHN0YXRpYyBzc2l6ZV90IHR1bl9nZXRfdXNlcihzdHJ1Y3QgdHVuX3N0
cnVjdA0KPiAqdHVuLCBzdHJ1Y3QgdHVuX2ZpbGUgKnRmaWxlLA0KPiA+ICAgICAgICAgICAgICAg
ICBicmVhazsNCj4gPiAgICAgICAgIH0NCj4gPg0KPiA+IC0gICAgICAgLyogY29weSBza2JfdWJ1
Zl9pbmZvIGZvciBjYWxsYmFjayB3aGVuIHNrYiBoYXMgbm8gZXJyb3IgKi8NCj4gPiAtICAgICAg
IGlmICh6ZXJvY29weSkgew0KPiA+IC0gICAgICAgICAgICAgICBza2Jfc2hpbmZvKHNrYiktPmRl
c3RydWN0b3JfYXJnID0gbXNnX2NvbnRyb2w7DQo+ID4gLSAgICAgICAgICAgICAgIHNrYl9zaGlu
Zm8oc2tiKS0+dHhfZmxhZ3MgfD0gU0tCVFhfREVWX1pFUk9DT1BZOw0KPiA+IC0gICAgICAgICAg
ICAgICBza2Jfc2hpbmZvKHNrYiktPnR4X2ZsYWdzIHw9IFNLQlRYX1NIQVJFRF9GUkFHOw0KPiA+
IC0gICAgICAgfSBlbHNlIGlmIChtc2dfY29udHJvbCkgew0KPiA+IC0gICAgICAgICAgICAgICBz
dHJ1Y3QgdWJ1Zl9pbmZvICp1YXJnID0gbXNnX2NvbnRyb2w7DQo+ID4gLSAgICAgICAgICAgICAg
IHVhcmctPmNhbGxiYWNrKHVhcmcsIGZhbHNlKTsNCj4gPiAtICAgICAgIH0NCj4gPiAtDQo+ID4g
ICAgICAgICBza2JfcmVzZXRfbmV0d29ya19oZWFkZXIoc2tiKTsNCj4gPiAgICAgICAgIHNrYl9w
cm9iZV90cmFuc3BvcnRfaGVhZGVyKHNrYik7DQo+ID4gICAgICAgICBza2JfcmVjb3JkX3J4X3F1
ZXVlKHNrYiwgdGZpbGUtPnF1ZXVlX2luZGV4KTsgQEAgLTE4MzAsNg0KPiA+ICsxODM0LDcgQEAg
c3RhdGljIHNzaXplX3QgdHVuX2dldF91c2VyKHN0cnVjdCB0dW5fc3RydWN0ICp0dW4sIHN0cnVj
dA0KPiB0dW5fZmlsZSAqdGZpbGUsDQo+ID4gICAgICAgICAgICAgICAgIHN0cnVjdCBicGZfcHJv
ZyAqeGRwX3Byb2c7DQo+ID4gICAgICAgICAgICAgICAgIGludCByZXQ7DQo+ID4NCj4gPiArICAg
ICAgICAgICAgICAgdHVuX2NvcHlfdWJ1Zl9pbmZvKHNrYiwgemVyb2NvcHksIG1zZ19jb250cm9s
KTsNCj4gPiAgICAgICAgICAgICAgICAgbG9jYWxfYmhfZGlzYWJsZSgpOw0KPiA+ICAgICAgICAg
ICAgICAgICByY3VfcmVhZF9sb2NrKCk7DQo+ID4gICAgICAgICAgICAgICAgIHhkcF9wcm9nID0g
cmN1X2RlcmVmZXJlbmNlKHR1bi0+eGRwX3Byb2cpOyBAQA0KPiAtMTg4MSw2DQo+ID4gKzE4ODYs
NyBAQCBzdGF0aWMgc3NpemVfdCB0dW5fZ2V0X3VzZXIoc3RydWN0IHR1bl9zdHJ1Y3QgKnR1biwg
c3RydWN0DQo+IHR1bl9maWxlICp0ZmlsZSwNCj4gPiAgICAgICAgICAgICAgICAgICAgICAgICBy
ZXR1cm4gLUVOT01FTTsNCj4gPiAgICAgICAgICAgICAgICAgfQ0KPiA+DQo+ID4gKyAgICAgICAg
ICAgICAgIHR1bl9jb3B5X3VidWZfaW5mbyhza2IsIHplcm9jb3B5LCBtc2dfY29udHJvbCk7DQo+
ID4gICAgICAgICAgICAgICAgIGxvY2FsX2JoX2Rpc2FibGUoKTsNCj4gPiAgICAgICAgICAgICAg
ICAgbmFwaV9ncm9fZnJhZ3MoJnRmaWxlLT5uYXBpKTsNCj4gPiAgICAgICAgICAgICAgICAgbG9j
YWxfYmhfZW5hYmxlKCk7DQo+ID4gQEAgLTE4ODksNiArMTg5NSw3IEBAIHN0YXRpYyBzc2l6ZV90
IHR1bl9nZXRfdXNlcihzdHJ1Y3QgdHVuX3N0cnVjdCAqdHVuLA0KPiBzdHJ1Y3QgdHVuX2ZpbGUg
KnRmaWxlLA0KPiA+ICAgICAgICAgICAgICAgICBzdHJ1Y3Qgc2tfYnVmZl9oZWFkICpxdWV1ZSA9
DQo+ICZ0ZmlsZS0+c2suc2tfd3JpdGVfcXVldWU7DQo+ID4gICAgICAgICAgICAgICAgIGludCBx
dWV1ZV9sZW47DQo+ID4NCj4gPiArICAgICAgICAgICAgICAgdHVuX2NvcHlfdWJ1Zl9pbmZvKHNr
YiwgemVyb2NvcHksIG1zZ19jb250cm9sKTsNCj4gPiAgICAgICAgICAgICAgICAgc3Bpbl9sb2Nr
X2JoKCZxdWV1ZS0+bG9jayk7DQo+ID4gICAgICAgICAgICAgICAgIF9fc2tiX3F1ZXVlX3RhaWwo
cXVldWUsIHNrYik7DQo+ID4gICAgICAgICAgICAgICAgIHF1ZXVlX2xlbiA9IHNrYl9xdWV1ZV9s
ZW4ocXVldWUpOyBAQCAtMTg5OSw4DQo+ICsxOTA2LDEwDQo+ID4gQEAgc3RhdGljIHNzaXplX3Qg
dHVuX2dldF91c2VyKHN0cnVjdCB0dW5fc3RydWN0ICp0dW4sIHN0cnVjdCB0dW5fZmlsZQ0KPiA+
ICp0ZmlsZSwNCj4gPg0KPiA+ICAgICAgICAgICAgICAgICBsb2NhbF9iaF9lbmFibGUoKTsNCj4g
PiAgICAgICAgIH0gZWxzZSBpZiAoIUlTX0VOQUJMRUQoQ09ORklHXzRLU1RBQ0tTKSkgew0KPiA+
ICsgICAgICAgICAgICAgICB0dW5fY29weV91YnVmX2luZm8oc2tiLCB6ZXJvY29weSwgbXNnX2Nv
bnRyb2wpOw0KPiA+ICAgICAgICAgICAgICAgICB0dW5fcnhfYmF0Y2hlZCh0dW4sIHRmaWxlLCBz
a2IsIG1vcmUpOw0KPiA+ICAgICAgICAgfSBlbHNlIHsNCj4gPiArICAgICAgICAgICAgICAgdHVu
X2NvcHlfdWJ1Zl9pbmZvKHNrYiwgemVyb2NvcHksIG1zZ19jb250cm9sKTsNCj4gPiAgICAgICAg
ICAgICAgICAgbmV0aWZfcnhfbmkoc2tiKTsNCj4gPiAgICAgICAgIH0NCj4gPiAgICAgICAgIHJj
dV9yZWFkX3VubG9jaygpOw0KPiA+IC0tDQo+ID4gMi4yMy4wDQo+ID4NCg==
