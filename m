Return-Path: <netdev-owner@vger.kernel.org>
X-Original-To: lists+netdev@lfdr.de
Delivered-To: lists+netdev@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 1E6E83FBD19
	for <lists+netdev@lfdr.de>; Mon, 30 Aug 2021 21:45:54 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S233414AbhH3Tqp (ORCPT <rfc822;lists+netdev@lfdr.de>);
        Mon, 30 Aug 2021 15:46:45 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:38066 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S230114AbhH3Tqo (ORCPT
        <rfc822;netdev@vger.kernel.org>); Mon, 30 Aug 2021 15:46:44 -0400
Received: from mail-pj1-x1029.google.com (mail-pj1-x1029.google.com [IPv6:2607:f8b0:4864:20::1029])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id DACDEC061575;
        Mon, 30 Aug 2021 12:45:50 -0700 (PDT)
Received: by mail-pj1-x1029.google.com with SMTP id u13-20020a17090abb0db0290177e1d9b3f7so246537pjr.1;
        Mon, 30 Aug 2021 12:45:50 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=date:from:to:cc:subject:message-id:references:mime-version
         :content-disposition:content-transfer-encoding:in-reply-to;
        bh=LKn8+yIzuQ85BsuOLPUdRV4iuBPgHQ6G99cL+fnYQKE=;
        b=DOCzSaIKS4fvKHdNqX26/r1vraRxc0k/WzeoYCfV+OR8jnX+Bs3gx2C+AYVGfj7mEq
         4QGIKoPa2Whu4esUfw8lafn3SzkGRMvA9cl8Lrtw6hwXcIDCphkiqcn5xPDG78HyokdV
         TaeBsVAU/dE6ZSEhP/b6uoi7yea7o3B7nW71UblYFdcNsY6/d2O2EMibyx7sWYOyO1pU
         m8S1289lnyeYaEbWga7fDZIRl5yKGiBl530DICN2XjYzF4bXb1TD6Ma4foxM5pSKNqPn
         yHQ7OR68GdgqWKsNVHNE9wjUERhx+N4lM31HoocHPoTioUtQ6hQCgT6oW27CtUpSDTEg
         zcUg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:date:from:to:cc:subject:message-id:references
         :mime-version:content-disposition:content-transfer-encoding
         :in-reply-to;
        bh=LKn8+yIzuQ85BsuOLPUdRV4iuBPgHQ6G99cL+fnYQKE=;
        b=qvk4moxwmPw8+AUGVk5AHlOfn9HqGN6kzN1XBgDr/cLDG2V9c3y7iR/zIVlY/pJm4E
         8yZFdNE3pCGQv5H9DgiKTFq5LpOW38CdQHplMzGWEg2qlR36Oh2cavZxUbKqbghhP8dq
         vVHkG20ceKnH4Ft3NV08CTEcVAlkVEz8XDQM9RAMTWttKxZ5OflrzktQ61N189bTUDP5
         TY2cH47iFFSisIOPIe9rDwpPKohoglD5BBOgX0UsFU+06hkRlyUIFTm56bH2wgV6aiFx
         FFItvt/+CtmiIZc1ASi08aL3iGIkJ825wX1/+ZdAJtryTDqI/gaOpNR/zVkoVQvrNBuR
         JLsw==
X-Gm-Message-State: AOAM531fKCxXPxaxfrJMI7w3G1G9S+LMk/nXttFHTAx08zilFy08BX1E
        aeoSVW8KOwWvFALsD1gVFyo=
X-Google-Smtp-Source: ABdhPJxLizShsSnhzCXPVv+NkcDLGA39cD8XsF3mmQUZQr4+S/y5rWSNZt4wD7bfGyqlroB3U5oriQ==
X-Received: by 2002:a17:902:a705:b029:12b:71be:d24e with SMTP id w5-20020a170902a705b029012b71bed24emr1149572plq.29.1630352750279;
        Mon, 30 Aug 2021 12:45:50 -0700 (PDT)
Received: from ast-mbp.dhcp.thefacebook.com ([2620:10d:c090:400::5:4106])
        by smtp.gmail.com with ESMTPSA id c123sm15553524pfc.50.2021.08.30.12.45.48
        (version=TLS1_3 cipher=TLS_AES_256_GCM_SHA384 bits=256/256);
        Mon, 30 Aug 2021 12:45:49 -0700 (PDT)
Date:   Mon, 30 Aug 2021 12:45:45 -0700
From:   Alexei Starovoitov <alexei.starovoitov@gmail.com>
To:     Dmitrii Banshchikov <me@ubique.spb.ru>
Cc:     bpf@vger.kernel.org, ast@kernel.org, davem@davemloft.net,
        daniel@iogearbox.net, andrii@kernel.org, kafai@fb.com,
        songliubraving@fb.com, yhs@fb.com, john.fastabend@gmail.com,
        kpsingh@kernel.org, netdev@vger.kernel.org, rdna@fb.com
Subject: Re: [PATCH bpf-next v2 12/13] bpfilter: Add filter table
Message-ID: <20210830194545.rgwg3ks3alikeyzx@ast-mbp.dhcp.thefacebook.com>
References: <20210829183608.2297877-1-me@ubique.spb.ru>
 <20210829183608.2297877-13-me@ubique.spb.ru>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <20210829183608.2297877-13-me@ubique.spb.ru>
Precedence: bulk
List-ID: <netdev.vger.kernel.org>
X-Mailing-List: netdev@vger.kernel.org

On Sun, Aug 29, 2021 at 10:36:07PM +0400, Dmitrii Banshchikov wrote:
>  /*
> - * # Generated by iptables-save v1.8.2 on Sat May  8 05:22:41 2021
> + *  Generated by iptables-save v1.8.2 on Sat May  8 05:22:41 2021
>   * *filter
...
> - * -A LOCAL -s 10.32.0.0/11 -j FROMDC
> - * -A LOCAL -s 10.144.0.0/12 -j FROMDC
> - * -A LOCAL -s 10.160.0.0/12 -j FROMDC
> - * -A LOCAL -s 10.0.0.0/12 -j FROMDC
> - * -A LOCAL -s 10.248.0.0/24 -j FROMDC
> - * -A LOCAL -s 10.232.0.0/16 -j FROMDC
> - * -A LOCAL -s 10.1.146.131/32 -p udp -m udp --dport 161 -j ACCEPT
> - * -A LOCAL -s 10.149.118.14/32 -p udp -m udp --dport 161 -j ACCEPT
> - * -A LOCAL -p icmp -j ACCEPT
> + * :INPUT ACCEPT [0:0]
> + * :FORWARD ACCEPT [0:0]
> + * :OUTPUT ACCEPT [0:0]
> + * -A INPUT -s 1.1.1.1/32 -d 2.2.2.2/32 -j DROP
> + * -A INPUT -s 2.2.0.0/16 -d 3.0.0.0/8 -j DROP
> + * -A INPUT -p udp -m udp --sport 100 --dport 500 -j DROP
>   * COMMIT
>   */

Patch 10 adds this test, but then patch 12 removes most of it?
Keep both?

Also hit this on my system with older glibc:

../net/bpfilter/codegen.c: In function ‘codegen_push_subprog’:
../net/bpfilter/codegen.c:67:4: warning: implicit declaration of function ‘reallocarray’ [-Wimplicit-function-declaration]
   67 |    reallocarray(codegen->subprogs, subprogs_max, sizeof(codegen->subprogs[0]));
      |    ^~~~~~~~~~~~
../net/bpfilter/codegen.c:66:12: warning: assignment to ‘struct codegen_subprog_desc **’ from ‘int’ makes pointer from integer without a cast [-Wint-conversion]
   66 |   subprogs =
      |            ^

In libbpf we have libbpf_reallocarray() for this reason.

Could you provide an example of generated bpf program?
And maybe add Documentation/bpf/bpfilter_design.rst ?

The tests don't build for me:
$ cd selftests/bpf/bpfilter; make
make: *** No rule to make target '-lelf', needed by '.../selftests/bpf/bpfilter/test_match'.  Stop.

The unit tests are great, btw. test_codegen is not end-to-end, right?
Could you add a full test with iptable command line?
or netns support is a prerequisite for it?
