Return-Path: <netdev-owner@vger.kernel.org>
X-Original-To: lists+netdev@lfdr.de
Delivered-To: lists+netdev@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.lfdr.de (Postfix) with ESMTP id E1A1D3996A
	for <lists+netdev@lfdr.de>; Sat,  8 Jun 2019 01:10:08 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1731330AbfFGXJC (ORCPT <rfc822;lists+netdev@lfdr.de>);
        Fri, 7 Jun 2019 19:09:02 -0400
Received: from mail-pg1-f173.google.com ([209.85.215.173]:35051 "EHLO
        mail-pg1-f173.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1729810AbfFGXJC (ORCPT
        <rfc822;netdev@vger.kernel.org>); Fri, 7 Jun 2019 19:09:02 -0400
Received: by mail-pg1-f173.google.com with SMTP id s27so1906761pgl.2
        for <netdev@vger.kernel.org>; Fri, 07 Jun 2019 16:09:01 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=netronome-com.20150623.gappssmtp.com; s=20150623;
        h=date:from:to:cc:subject:message-id:in-reply-to:references
         :organization:mime-version:content-transfer-encoding;
        bh=wPb/wY/tS0XmpPrjeiNUI1u/0QAwojfhWHpeJcA/Ql0=;
        b=b/6Z2VJBqSfyPqQreQIZEzn4zmUkelPG+ExpKPJ89P77n2oSirvFXF4DJMOgnRPLf9
         EibeQA98C9R9DOi9l0xKFDNiEyN+0OJdRcGT0+uLl5ZMNgDmIXFMlTfLdMXqC/dw1kzN
         zrHuii+nq+YjTv69iKyEpZXMfmJ8OfZqe5z7eDAJ6hRhlXL/RilcJweXkgN0iF1fh/aa
         GvSxtIZxOciNM8+VFbo1x1KeQU8crkCobZkDwXTqAmohUGVlSIcN+Fd6V4VnDLBLH/Az
         VsP6MppfyGUghZ/d4TFpcHC9QJiHNfuvrPRVe46eDOdXIeGT9J2R6AsF/200jeVu/9WN
         Z7cQ==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:date:from:to:cc:subject:message-id:in-reply-to
         :references:organization:mime-version:content-transfer-encoding;
        bh=wPb/wY/tS0XmpPrjeiNUI1u/0QAwojfhWHpeJcA/Ql0=;
        b=Ft/OTXEcjvs6r76wFDVifMvUkZRD0NVeyCQ4dTgyrpbBJA8DY7P1+r6NL8znVnExRd
         zT/jy0mn4y6WvHrH+9o9ZvjlGdn92UrzXiau89NIt/WbqFzbXNfr+bgYZZyBXDbCY19f
         +s24Zanj4KvotdwddVeENKzfGeD8k9Jr/s6Qayf15IG55JNbNvg2dGRsP6cTmxBnpE52
         jdrl0Nm4peejZbdD/EnlJjdx2iLUw/+gxS0w/eWhMbVxXf5ZuMg0NFB24nt0PbF9qrFm
         ZlkOl57Q+2O1rv2iudGoDmk4/VkatQEgkvVKnV1BO1RwlvFfHeVen2U1MmGnwl11Plu5
         jIsQ==
X-Gm-Message-State: APjAAAXlUN6+Zl7hTFmT4Q7V2xFGOALtEe/3AzDp3lDwqaPL9oZFotpr
        ao0PIb6GCKiRRRO53cfMoG0EUc2MFf4=
X-Google-Smtp-Source: APXvYqy9vqHfS0k8FlKVWbmP199XQ1fcHL5JnAZkiQmhF/KFxEhjJIncUa6DR4P599eX/I8VfN5Vqg==
X-Received: by 2002:a63:205b:: with SMTP id r27mr5269337pgm.330.1559948941274;
        Fri, 07 Jun 2019 16:09:01 -0700 (PDT)
Received: from cakuba.netronome.com (wsip-98-171-133-120.sd.sd.cox.net. [98.171.133.120])
        by smtp.gmail.com with ESMTPSA id i5sm2553760pjj.8.2019.06.07.16.09.00
        (version=TLS1_3 cipher=AEAD-AES256-GCM-SHA384 bits=256/256);
        Fri, 07 Jun 2019 16:09:01 -0700 (PDT)
Date:   Fri, 7 Jun 2019 16:08:57 -0700
From:   Jakub Kicinski <jakub.kicinski@netronome.com>
To:     =?UTF-8?B?7JaR7Jyg7ISd?= <ileixe@gmail.com>
Cc:     netdev@vger.kernel.org
Subject: Re: How net_device feature flag of 'tx-udp_tnl-segmetnation' is
 decided?
Message-ID: <20190607160857.23a31e98@cakuba.netronome.com>
In-Reply-To: <CAFAx9ab=Wys2QU+nsh-O_XyOKw9T1ACziphzRW4ARYAwA30xEw@mail.gmail.com>
References: <CAFAx9ab=Wys2QU+nsh-O_XyOKw9T1ACziphzRW4ARYAwA30xEw@mail.gmail.com>
Organization: Netronome Systems, Ltd.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
Sender: netdev-owner@vger.kernel.org
Precedence: bulk
List-ID: <netdev.vger.kernel.org>
X-Mailing-List: netdev@vger.kernel.org

On Fri, 7 Jun 2019 15:56:48 +0900, =EC=96=91=EC=9C=A0=EC=84=9D wrote:
> Hi netdev!
>=20
> I'm kernel newbie and I'm not sure it's right place to ask though, if
> not please let me know the right place. :)
>=20
> I sent this mail to ask about net_device interface feature called
> 'tx-udp_tnl-segmentation'. Ethtool does not appear correct status of
> offloading, even if the vxlan offloading is enabled. Ethtool show like
> below for vxlan interface.
>=20
> deploy@krane-pg1-com1000:~$ ethtool --show-offload vxlan100
> Features for vxlan100:
> tx-udp_tnl-segmentation: off [fixed]
>=20
> deploy@krane-pg1-com1000:~$ ethtool --show-offload eth0
> Features for eth0:
> tx-udp_tnl-csum-segmentation: on
>=20
> Tcpdumping show offload is correctly applied in vxlan interface, so I
> wonder this is bug for vxlan implementation. I found
> drivers/net/vxlan.c does not set the feature SKB_GSO_UDP_TUNNEL, just
> applying the flag at creation time. Is it bug or something that I
> misunderstood?

The flag is set on the lower interface, not on the tunnel interface.
It means that the interface can perform TCP segmentation over a UDP
header.

IOW packet gets generated by the TCP code and it gets tagged as
requiring normal segmentation (tx-tcp-segmentation).  It then
reaches the vxlan0 device - since the packet only requires normal
segmentation at this point the "tx-udp_tnl-segmentation" feature isn't
checked.  When the packet passes through the VXLAN device it is
additionally tagged as requiring segmentation over UDP.  Now whatever
the packet arrives at next needs to have "tx-udp_tnl-segmentation"
offload, otherwise the kernel will perform segmentation in software.

HTH
